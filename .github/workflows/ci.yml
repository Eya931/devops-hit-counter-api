name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest bandit
      
      - name: Run unit tests
        run: pytest tests/ -v --tb=short
      
      - name: SAST: Run Bandit security scan
        run: bandit -r app/ -f json -o bandit-report.json || true
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json
      
      - name: Build Docker image
        run: docker build -t hit-counter-api:${{ github.sha }} .
      
      - name: Run container tests
        run: |
          docker run --rm -d -p 5000:5000 --name test-api hit-counter-api:${{ github.sha }}
          sleep 3
          curl -f http://localhost:5000/health || exit 1
          docker stop test-api

  security-dast:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -t hit-counter-api:latest .
      
      - name: Run container for DAST
        run: |
          docker run -d -p 5000:5000 --name dast-api hit-counter-api:latest
          sleep 3
      
      - name: DAST: Run basic security checks
        run: |
          # Check if API responds
          curl -f http://localhost:5000/health || exit 1
          echo "✓ API health check passed"
          
          # Test invalid input handling
          curl -X POST http://localhost:5000/api/pages -H "Content-Type: application/json" -d '{}' -w "\nStatus: %{http_code}\n" | grep "400"
          echo "✓ Invalid input rejected"
          
          # Test 404 handling
          curl -s http://localhost:5000/api/pages/999 -w "Status: %{http_code}" | grep "404"
          echo "✓ 404 handling working"
        continue-on-error: true
      
      - name: Stop container
        run: docker stop dast-api || true